name: Build & Deploy Laravel to Shared Hosting

on:
  push:
    branches:
      - production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ§° Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, xml, bcmath

      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Install NPM dependencies & build
        run: |
          npm ci
          npm run build

      - name: ğŸ§¼ Clean up dev files
        run: |
          rm -rf node_modules tests .github
          
      - name: Setup SSH key for authentication
        run: |
            mkdir -p ~/.ssh
            echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -H ${{ secrets.SFTP_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy Laravel core to laravel_project/
        run: |
            rsync -avz --exclude public/ --delete ./ username@${{ secrets.SSH_HOST }}:/domains/omdatwereizen.nl/laravel_project

      - name: ğŸŒ Deploy public/ to DEFAULT/
        run: |
            rsync -avz ./public/ username@${{ secrets.SSH_HOST }}:/domains/omdatwereizen.nl/DEFAULT