name: ğŸš€ Deploy Laravel App to Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ§° Setup PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, bcmath, intl, pdo, openssl

      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: ğŸ§¶ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: ğŸ“¦ Install NPM dependencies
        run: npm ci

      - name: ğŸ”¨ Build Vite assets
        run: npm run build

      - name: ğŸ§¼ Clean up dev files
        run: |
          rm -rf node_modules tests .github

      - name: ğŸ§  Set production paths in index.php
        run: |
          sed -i "s|__DIR__.'/../vendor/autoload.php'|__DIR__.'/../../laravel_project/vendor/autoload.php'|" public/index.php
          sed -i "s|__DIR__.'/../bootstrap/app.php'|__DIR__.'/../../laravel_project/bootstrap/app.php'|" public/index.php

      - name: ğŸ˜ Prepare logs and permissions
        run: |
          mkdir -p storage/logs
          touch storage/logs/laravel.log
          chmod -R 775 storage bootstrap/cache
      - name: ğŸ”‘ Setup SSH key for authentication
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸšš Upload to server
        run: |
          chmod 600 ~/.ssh/id_rsa
          rsync -avz --delete \
            --exclude=node_modules \
            --exclude=.git \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ./ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/domains/omdatwereizen.nl/laravel_project

      - name: ğŸŒ Deploy public/ to DEFAULT/
        run: |
          rsync -avz ./public/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/domains/omdatwereizen.nl/DEFAULT

      - name: ğŸ“ Copy .env on server
        run: |
          ssh -i ~/.ssh/deploy ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "\
            cp /domains/omdatwereizen.nl/.env /domains/omdatwereizen.nl/laravel_project/.env && \
            cd /domains/omdatwereizen.nl/laravel_project && \
            php artisan key:generate && \
            php artisan config:clear && \
            php artisan config:cache && \
            php artisan route:cache && \
            php artisan view:cache"
