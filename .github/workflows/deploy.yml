name: Deploy to Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Add SSH key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}

    - name: Deploy to Debian server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e

          echo "ðŸ”„ Switching to project directory"
          cd /domains/omdatwereizen.nl

          echo "ðŸ“¥ Pulling latest changes"
          git pull origin production

          echo "ðŸ’¾ Installing PHP dependencies"
          composer install --no-dev --optimize-autoloader

          echo "ðŸ“¦ Installing Node dependencies"
          npm ci

          echo "âš™ï¸ Building frontend"
          npm run build

          echo "ðŸ§¼ Clearing and caching Laravel config"
          php artisan config:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          echo "ðŸ“‚ Running migrations"
          # php artisan migrate --force

          echo "âœ… Deployment complete"
        EOF
