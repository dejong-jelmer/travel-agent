name: Deploy to Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Add SSH key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}

    - name: Deploy to Debian server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e

          echo "🔄 Switching to project directory"
          cd /domains/omdatwereizen.nl

          echo "📥 Pulling latest changes"
          git pull origin production

          echo "💾 Installing PHP dependencies"
          composer install --no-dev --optimize-autoloader

          echo "📦 Installing Node dependencies"
          npm ci

          echo "⚙️ Building frontend"
          npm run build

          echo "🧼 Clearing and caching Laravel config"
          php artisan config:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          echo "📂 Running migrations"
          # php artisan migrate --force

          echo "✅ Deployment complete"
        EOF
