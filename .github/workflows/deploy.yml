name: Build & Deploy Laravel to Shared Hosting

on:
  push:
    branches:
      - production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ§° Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, xml, bcmath

      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Install NPM dependencies & build
        run: |
          npm ci
          npm run build

      - name: ğŸ§¼ Clean up dev files
        run: |
          rm -rf node_modules tests .github

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: ğŸš€ Deploy Laravel core to laravel_project/
        run: |
            lftp -u ${{ secrets.SFTP_USER }},${{ secrets.SFTP_PASSWORD }} sftp://${{ secrets.SFTP_HOST }} <<EOF
            mirror --reverse --verbose --exclude public/ ./ /domains/omdatwereizen.nl/laravel_project
            EOF

      - name: ğŸŒ Deploy public/ to DEFAULT/
        run: |
            lftp -u ${{ secrets.SFTP_USER }},${{ secrets.SFTP_PASSWORD }} sftp://${{ secrets.SFTP_HOST }} <<EOF
            mirror --reverse --verbose ./public /domains/omdatwereizen.nl/DEFAULT
            EOF
